<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAIC Study Step 2</title>
    <!-- CSS LINK -->
    <link rel="stylesheet" href="stylesheet.css">
    <!-- BOOTSTRAP LINK -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
</head>

<body>

    <!-- ===================== SINGLE SCRIPT BLOCK ===================== -->
    <script>
        var gameDataJson = null;

        function ReceiveGameDataFromUnity(jsonData) {
            gameDataJson = jsonData;
            console.log("✅ Data received from Unity:", gameDataJson);
            document.title = "Data Ready ✅"; // visual confirmation
        }

        function continueStudy() {
            if (!gameDataJson) {
                alert("Waiting for game data... Please finish the game first.");
                return;
            }

            fetch("https://script.google.com/macros/s/AKfycbwviVqxfIdMkK5IIJtUWEOIbOlw1Z8C_FEfzYlHOqXvLo3Hfafy3C3UV7H3Unmgzfr5/exec", {
                method: "POST",
                body: gameDataJson  // no Content-Type header — avoids CORS preflight
            })
            .then(response => response.text())
            .then(data => {
                console.log("✅ Upload success:", data);
                window.location.href = "finalSurvey.html";
            })
            .catch(error => {
                console.error("❌ Upload error:", error);
                window.location.href = "finalSurvey.html"; // still redirect
            });
        }
    </script>
    <!-- ============================================================== -->

    <!-- Logo -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-2 mt-2"><img src="logo_H1.png" class="logo"></div>
            <div class="col-lg-2"><img src="logoInesc.png" class="logo"></div>
            <div class="col-lg-2 mt-3"><img src="logoIst.png" class="logo"></div>
        </div>
    </div>

    <div class="container section" id="section3" style="margin-top: 5%;">
        <div class="container">
            <div class="row mt-5">
                <div class="col-lg-12">
                    <h1 style="text-align: center;" class="stepTitle nunito">STEP 2</h1>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-lg-2">
                    <img src="Arrows.png">
                </div>
                <div class="col-lg-8">
                    <p style="text-align: center; margin-top: 5%;">In this step, you will <span>play a game</span> with the help of your <span>AI team member</span></p>
                    <p style="text-align: center;">to capture demons that were accidentaly summoned by a wizard.</p>
                    <br>
                </div>
                <div class="col-lg-2">
                    <img src="Arrows.png">
                </div>
                <div><hr></div>
            </div>

            <div class="row mt-4">
                <div class="col-lg-12">
                    <p style="text-align: center;">You will have a tutorial in the game to help you understand the game.</p>
                    <p style="text-align: center;">Please, do not skip the tutorial.</p>
                    <p style="text-align: center; font-size: 30px;"><span>Have fun!</span></p>
                </div>
            </div>

            <div style="margin-top: 3%; margin-bottom: 5%;"><hr></div>

            <!-- Unity WebGL Game (direct embed, no iframe) -->
            <div class="col-lg-12 d-flex justify-content-center">
                <div style="width: 960px; height: 540px; position: relative; background: #000;">
                    <canvas id="unity-canvas" style="width: 960px; height: 540px; display: block;"></canvas>
                    <div id="unity-loading" style="
                        position: absolute; top: 0; left: 0;
                        width: 100%; height: 100%;
                        display: flex; flex-direction: column;
                        align-items: center; justify-content: center;
                        color: white; font-family: Nunito, sans-serif;
                        background: #1a1a2e;">
                        <p>Loading game...</p>
                        <progress id="unity-progress" value="0" max="1" style="width: 60%;"></progress>
                    </div>
                </div>
            </div>

            <!-- Unity Loader Script -->
            <script src="WGL5/Build/WGL5.loader.js"></script>
            <script>
                createUnityInstance(document.querySelector("#unity-canvas"), {
                    dataUrl:      "WGL5/Build/WGL5.data",
                    frameworkUrl: "WGL5/Build/WGL5.framework.js",
                    codeUrl:      "WGL5/Build/WGL5.wasm",
                }, function(progress) {
                    document.querySelector("#unity-progress").value = progress;
                }).then(function(unityInstance) {
                    // Hide loading screen once ready
                    document.getElementById("unity-loading").style.display = "none";
                    console.log("Unity loaded successfully.");
                }).catch(function(message) {
                    console.error("Unity failed to load:", message);
                });
            </script>

            <div style="margin-top: 3%; margin-bottom: 5%;"><hr></div>

            <div class="row mt-5">
                <button class="buttonStep1" onclick="continueStudy()">Continue</button>
            </div>

        </div>
    </div>

    <div class="container">
        <div class="row mt-5"></div>
    </div>
    <div class="container">
        <div class="row mt-5"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

</body>
</html>
